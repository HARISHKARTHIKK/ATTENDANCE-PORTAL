{% extends "base.html" %}

{% block title %}Mark Attendance - Attendance Portal{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12 text-center text-md-start">
        <h2 class="fw-bold mt-4 mt-md-0"><i class="bi bi-calendar-check-fill me-2 text-primary"></i>Mark Attendance</h2>
        <p class="text-muted">Select Class <i class="bi bi-chevron-right mx-1"></i> Subjects & Students are auto-loaded
            based on current semester.</p>
    </div>
</div>

<form method="POST">
    <div class="row mb-4 g-3">
        <div class="col-12 col-md-4">
            <div class="card p-3 border-0 shadow-sm h-100">
                <label class="form-label small fw-bold text-uppercase text-muted">1. Select Class</label>
                <select name="class_id" id="att_class" class="form-select border-0 bg-light" required>
                    <option value="">-- Choose Class --</option>
                    {% for cls in classes %}
                    <option value="{{ cls.id }}">{{ cls.name }} ({{ cls.dept }})</option>
                    {% endfor %}
                </select>
                <div id="class_info" class="mt-2 small text-primary fw-bold" style="display:none;">
                    Current Semester: <span id="current_sem_display"></span>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-4">
            <div class="card p-3 border-0 shadow-sm h-100">
                <label class="form-label small fw-bold text-uppercase text-muted">2. Select Subject</label>
                <select name="subject_id" id="subject_select" class="form-select border-0 bg-light text-primary fw-bold"
                    required disabled>
                    <option value="">-- Choose Subject --</option>
                </select>
            </div>
        </div>
        <div class="col-12 col-md-4">
            <div class="card p-3 border-0 shadow-sm h-100">
                <label class="form-label small fw-bold text-uppercase text-muted">3. Date</label>
                <input type="date" name="date" class="form-control border-0 bg-light" value="{{ today }}" required>
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-sm overflow-hidden mb-4">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-primary text-white">
                    <tr>
                        <th class="ps-4">Roll No</th>
                        <th>Student Name</th>
                        <th class="text-center">Status</th>
                    </tr>
                </thead>
                <tbody id="student_list_body">
                    <tr>
                        <td colspan="3" class="text-center py-5">
                            <p class="text-muted">Please select a class to load subjects and students.</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="text-end mb-5">
        <button type="submit" class="btn btn-primary btn-lg px-5 shadow rounded-3">
            <i class="bi bi-cloud-upload me-2"></i>Save Attendance Records
        </button>
    </div>
</form>
{% endblock %}

{% block scripts %}
<script>
    const attClass = document.getElementById('att_class');
    const attSub = document.getElementById('subject_select');
    const body = document.getElementById('student_list_body');
    const classInfo = document.getElementById('class_info');
    const semDisplay = document.getElementById('current_sem_display');

    attClass.addEventListener('change', function () {
        if (!this.value) {
            attSub.disabled = true;
            classInfo.style.display = 'none';
            body.innerHTML = '<tr><td colspan="3" class="text-center py-5"><p class="text-muted">Select a class to load subjects and students.</p></td></tr>';
            return;
        }

        // 1. Get Class Details (Semester & Dept)
        fetch(`/api/get_class_details/${this.value}`)
            .then(res => res.json())
            .then(cls => {
                semDisplay.textContent = cls.current_semester;
                classInfo.style.display = 'block';

                // 2. Load Subjects for this Semester + Dept
                fetch(`/api/get_subjects_by_semester/${cls.current_semester}/${cls.dept}`)
                    .then(res => res.json())
                    .then(subjects => {
                        attSub.innerHTML = '<option value="">-- Choose Subject --</option>';
                        if (subjects.length === 0) {
                            attSub.innerHTML = '<option value="">No subjects mapped for Sem ' + cls.current_semester + '</option>';
                        } else {
                            subjects.forEach(s => {
                                attSub.innerHTML += `<option value="${s.id}">${s.name} (${s.code})</option>`;
                            });
                            attSub.disabled = false;
                        }
                    });

                // 3. Load Students for this Class
                body.innerHTML = '<tr><td colspan="3" class="text-center py-5"><div class="spinner-border text-primary"></div></td></tr>';
                fetch(`/api/get_students_by_class/${cls.id}`)
                    .then(res => res.json())
                    .then(students => {
                        if (students.length === 0) {
                            body.innerHTML = '<tr><td colspan="3" class="text-center py-5"><p class="text-muted">No students found in this class.</p></td></tr>';
                        } else {
                            body.innerHTML = '';
                            students.forEach(student => {
                                const row = `
                            <tr>
                                <td class="ps-4 fw-bold text-muted">${student.roll_no}</td>
                                <td class="fw-semibold">${student.name}</td>
                                <td class="text-center">
                                    <div class="btn-group" role="group">
                                        <input type="radio" class="btn-check" name="status_${student.id}" id="present_${student.id}" value="Present" checked>
                                        <label class="btn btn-outline-success px-3 py-2 fw-bold" for="present_${student.id}">P</label>
                                        
                                        <input type="radio" class="btn-check" name="status_${student.id}" id="absent_${student.id}" value="Absent">
                                        <label class="btn btn-outline-danger px-3 py-2 fw-bold" for="absent_${student.id}">A</label>

                                        <input type="radio" class="btn-check" name="status_${student.id}" id="od_${student.id}" value="OD">
                                        <label class="btn btn-outline-info px-3 py-2 fw-bold" for="od_${student.id}">OD</label>

                                        <input type="radio" class="btn-check" name="status_${student.id}" id="ml_${student.id}" value="ML">
                                        <label class="btn btn-outline-warning px-3 py-2 fw-bold" for="ml_${student.id}">ML</label>

                                        <input type="radio" class="btn-check" name="status_${student.id}" id="late_${student.id}" value="Late">
                                        <label class="btn btn-outline-secondary px-3 py-2 fw-bold" for="late_${student.id}">L</label>
                                    </div>
                                </td>
                            </tr>`;
                                body.insertAdjacentHTML('beforeend', row);
                            });
                        }
                    });
            });
    });
</script>
{% endblock %}