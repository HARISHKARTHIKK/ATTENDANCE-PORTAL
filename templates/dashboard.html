{% extends "base.html" %}

{% block title %}Dashboard - Attendance Portal{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12 text-center text-md-start">
        <h2 class="fw-bold mb-0 mt-4 mt-md-0"><i class="bi bi-grid-1x2-fill me-2 text-primary"></i>Dashboard overview
        </h2>
        <p class="text-muted">Welcome back, <strong>{{ current_user.name }}</strong>! Monitoring student progress in
            real-time.</p>
    </div>
</div>

<!-- Quick Action Card -->
<div class="row mb-5">
    <div class="col-md-12">
        <div class="card border-0 shadow-lg overflow-hidden position-relative"
            style="background: linear-gradient(135deg, #4361ee 0%, #3f37c9 100%); border-radius: 20px;">
            <div class="card-body p-4 p-md-5">
                <div class="row align-items-center">
                    <div class="col-md-7 text-center text-md-start position-relative" style="z-index: 2;">
                        <h1 class="display-5 fw-bold text-white mb-3">Record Attendance</h1>
                        <p class="text-white-50 fs-5 mb-4">Select your subject and mark today's attendance in seconds.
                            Stay organized and updated.</p>
                        <a href="{{ url_for('attendance_shortcut') }}"
                            class="btn btn-white btn-lg px-4 px-md-5 py-3 fw-bold text-primary shadow-lg bg-white border-0"
                            style="border-radius: 12px; transition: all 0.3s;">
                            <i class="bi bi-calendar-check-fill me-2"></i>Mark Attendance Now
                        </a>
                    </div>
                    <div class="col-md-5 d-none d-md-block text-center position-relative">
                        <i class="bi bi-clipboard2-check text-white opacity-25"
                            style="font-size: 10rem; position: absolute; right: 0; bottom: -50px;"></i>
                        <div class="glass-orb"
                            style="position: absolute; right: 50px; top: -20px; width: 150px; height: 150px; background: rgba(255,255,255,0.1); border-radius: 50%; backdrop-filter: blur(5px);">
                        </div>
                    </div>
                </div>
            </div>
            <!-- Decorative shapes -->
            <div
                style="position: absolute; top: -100px; right: -100px; width: 300px; height: 300px; background: rgba(255,255,255,0.05); border-radius: 50%;">
            </div>
            <div
                style="position: absolute; bottom: -50px; left: -50px; width: 200px; height: 200px; background: rgba(255,255,255,0.05); border-radius: 50%;">
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mb-5">
    <div class="col-12 col-md-6 col-lg-3">
        <div class="card stats-card h-100 p-3 p-md-4">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="text-uppercase mb-2 opacity-75 small">Total Students</h6>
                    <h2 class="fw-bold mb-0">{{ total_students }}</h2>
                </div>
                <div class="fs-1 opacity-50"><i class="bi bi-people"></i></div>
            </div>
        </div>
    </div>
    {% if current_user.role == 'admin' %}
    <div class="col-12 col-md-6 col-lg-3">
        <div class="card bg-white h-100 p-3 p-md-4 border-start border-4 border-info">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="text-uppercase mb-2 text-muted small">Total Teachers</h6>
                    <h2 class="fw-bold mb-0">{{ total_teachers }}</h2>
                </div>
                <div class="fs-1 text-info opacity-50"><i class="bi bi-person-badge"></i></div>
            </div>
        </div>
    </div>
    {% endif %}
    <div class="col-12 col-md-6 col-lg-{% if current_user.role == 'admin' %}3{% else %}4{% endif %}">
        <div class="card bg-white h-100 p-3 p-md-4 border-start border-4 border-warning">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="text-uppercase mb-2 text-muted small">Total Subjects</h6>
                    <h2 class="fw-bold mb-0">{{ total_subjects }}</h2>
                </div>
                <div class="fs-1 text-warning opacity-50"><i class="bi bi-journal-text"></i></div>
            </div>
        </div>
    </div>
    <div class="col-12 col-md-6 col-lg-{% if current_user.role == 'admin' %}3{% else %}4{% endif %}">
        <div class="card bg-white h-100 p-3 p-md-4 border-start border-4 border-success">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="text-uppercase mb-2 text-muted small">Overall Attendance</h6>
                    <h2 class="fw-bold mb-0">{% if report_data %}{{ (report_data|sum(attribute='perc') /
                        report_data|length)|round(1) }}{% else %}0{% endif %}%</h2>
                </div>
                <div class="fs-1 text-success opacity-50"><i class="bi bi-check2-circle"></i></div>
            </div>
        </div>
    </div>
</div>

{% if current_user.role == 'in_charge' %}
<div class="row g-4 mb-5">
    <div class="col-md-12">
        <h4 class="fw-bold mb-3">Class In-charge Overview: {{ in_charge_data.class_name }}</h4>
    </div>
    <div class="col-12 col-md-6">
        <div class="card border-0 shadow-lg text-white"
            style="background: linear-gradient(45deg, #2ecc71, #27ae60); border-radius: 20px;">
            <div class="card-body p-4 p-md-5">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-uppercase opacity-75 mb-2 small">Today's Present</h6>
                        <h1 class="display-3 fw-bold mb-0">{{ in_charge_data.present }}</h1>
                    </div>
                    <i class="bi bi-person-check-fill opacity-25" style="font-size: 4rem;"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-12 col-md-6">
        <div class="card border-0 shadow-lg text-white"
            style="background: linear-gradient(45deg, #e74c3c, #c0392b); border-radius: 20px;">
            <div class="card-body p-4 p-md-5">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-uppercase opacity-75 mb-2 small">Today's Absent</h6>
                        <h1 class="display-3 fw-bold mb-0">{{ in_charge_data.absent }}</h1>
                    </div>
                    <i class="bi bi-person-x-fill opacity-25" style="font-size: 4rem;"></i>
                </div>
            </div>
        </div>
    </div>
</div>
{% elif current_user.role in ['hod', 'admin', 'teacher'] %}
<div class="row mb-5">
    <div class="col-12 col-md-12">
        <div class="card border-0 shadow-sm p-3 p-md-4" style="border-radius: 15px;">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4">
                <h5 class="fw-bold mb-3 mb-md-0">Today's Attendance Summary {% if current_user.role == 'teacher' %}{%
                    else %}(HOD Overview){% endif %}</h5>
                <span class="badge bg-primary px-3 py-2 align-self-start">{{ today_date }}</span>
            </div>
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="bg-light">
                        <tr>
                            <th>Class Name</th>
                            <th>Total Present</th>
                            <th>Total Absent</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in hod_summary %}
                        <tr>
                            <td class="fw-bold text-primary">{{ item.class_name }}</td>
                            <td><span class="badge bg-success" style="font-size: 0.9rem;">{{ item.present }}
                                    Present</span></td>
                            <td><span class="badge bg-danger" style="font-size: 0.9rem;">{{ item.absent }} Absent</span>
                            </td>
                            <td>
                                {% if item.present > 0 %}
                                <span class="text-success small fw-bold"><i class="bi bi-circle-fill me-1"></i>
                                    Updated</span>
                                {% else %}
                                <span class="text-muted small">Pending</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Department Wise Attendance -->
<div class="row mb-5">
    <div class="col-12">
        <div class="d-flex align-items-center mb-4">
            <h4 class="fw-bold mb-0"><i class="bi bi-diagram-3 me-2 text-primary"></i>Department Wise Statistics</h4>
            <div class="ms-auto">
                <a href="{{ url_for('departments') }}" class="btn btn-sm btn-outline-primary">Manage Depts</a>
            </div>
        </div>
    </div>
    {% for dept in dept_stats %}
    <div class="col-12 col-md-6 col-lg-4 mb-4">
        <div class="card border-0 shadow-sm h-100 overflow-hidden" style="border-radius: 20px;">
            <div class="card-header bg-white border-0 pt-4 px-4 pb-0 d-flex justify-content-between align-items-center">
                <h5 class="fw-bold mb-0 text-truncate" style="max-width: 70%;">{{ dept.name }}</h5>
                <span class="badge bg-primary-subtle text-primary px-3">{{ dept.code }}</span>
            </div>
            <div class="card-body p-4">
                <div class="row text-center mb-4">
                    <div class="col-4 border-end">
                        <div class="text-muted small text-uppercase fw-bold mb-1" style="font-size: 0.65rem;">Total
                        </div>
                        <div class="h5 fw-bold mb-0 text-primary">{{ dept.total_students }}</div>
                    </div>
                    <div class="col-4 border-end">
                        <div class="text-muted small text-uppercase fw-bold mb-1" style="font-size: 0.65rem;">Present
                        </div>
                        <div class="h5 fw-bold mb-0 text-success">{{ dept.present }}</div>
                    </div>
                    <div class="col-4">
                        <div class="text-muted small text-uppercase fw-bold mb-1" style="font-size: 0.65rem;">Absent
                        </div>
                        <div class="h5 fw-bold mb-0 text-danger">{{ dept.absent }}</div>
                    </div>
                </div>

                {% set total_marked = dept.present + dept.absent %}
                {% if total_marked > 0 %}
                {% set perc = (dept.present / total_marked * 100)|round(1) %}
                {% else %}
                {% set perc = 0 %}
                {% endif %}

                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="text-muted small fw-bold">Live Presence</span>
                    <span
                        class="badge {% if perc >= 75 %}bg-success{% elif perc >= 50 %}bg-warning{% else %}bg-danger{% endif %} rounded-pill">
                        {{ perc }}%
                    </span>
                </div>
                <div class="progress" style="height: 8px; border-radius: 4px;">
                    <div class="progress-bar {% if perc >= 75 %}bg-success{% elif perc >= 50 %}bg-warning{% else %}bg-danger{% endif %}"
                        role="progressbar" style="width: {{ perc }}%"></div>
                </div>

                <div class="mt-3 d-flex align-items-center text-muted small">
                    <i class="bi bi-clock-history me-2"></i>
                    <span>{{ dept.late }} case(s) marked late</span>
                </div>
            </div>
            <div class="card-footer bg-light border-0 py-3 px-4">
                <a href="{{ url_for('reports', dept=dept.name) }}"
                    class="btn btn-link btn-sm p-0 text-decoration-none fw-bold">
                    Analysis View <i class="bi bi-arrow-right ms-1"></i>
                </a>
            </div>
        </div>
    </div>
    {% else %}
    <div class="col-12 text-center py-5">
        <div class="card p-5 border-0 shadow-sm" style="border-radius: 20px;">
            <i class="bi bi-building-exclamation text-muted mb-3" style="font-size: 3rem;"></i>
            <h5 class="text-muted">No departments found</h5>
            <p class="text-muted small mb-4">Start by adding departments to see their analytics here.</p>
            <div>
                <a href="{{ url_for('departments') }}" class="btn btn-primary px-4">Add Department</a>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<div class="row">
    <div class="col-12 col-md-12">
        <div class="card p-3 p-md-4">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4">
                <h5 class="fw-bold mb-3 mb-md-0">Quick Student Summary</h5>
                <a href="{{ url_for('reports') }}" class="btn btn-sm btn-outline-primary align-self-start">View Full
                    Report</a>
            </div>
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="bg-light">
                        <tr>
                            <th>Roll No</th>
                            <th>Student Name</th>
                            <th>Department</th>
                            <th>Attendance %</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for student in report_data %}
                        <tr>
                            <td><span class="badge bg-light text-dark border">{{ student.roll_no }}</span></td>
                            <td class="fw-semibold">{{ student.name }}</td>
                            <td>{{ student.dept }}</td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="progress flex-grow-1 me-2" style="height: 6px;">
                                        <div class="progress-bar {% if student.perc < 75 %}bg-danger{% else %}bg-success{% endif %}"
                                            role="progressbar" style="width: {{ student.perc }}%"></div>
                                    </div>
                                    <span class="small fw-bold">{{ student.perc }}%</span>
                                </div>
                            </td>
                            <td>
                                {% if student.perc < 75 %} <span class="badge bg-danger">Critical</span>
                                    {% else %}
                                    <span class="badge bg-success">Good</span>
                                    {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="5" class="text-center py-4 text-muted">No student records found.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}